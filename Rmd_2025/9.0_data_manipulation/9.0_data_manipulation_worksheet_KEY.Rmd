# 9.0 Data Manipulation

Name:

Date:

------------------------------------------------------------------------

We will start with a fresh, clean environment. The code chunk below clears your environment if you want to reset your work in interactive mode. Or use the broom button on the top right corner.

```{r}
rm(list = ls())
```

## Loading packages and data

Today we will learn about data manipulation using the "split-apply-combine" strategy. This is really helpful because you can organize big datasets into more organized pieces and then put it back together.

Load the necessary packages:

```{r}
library(tidyverse)
library(palmerpenguins)
```

Load the penguins data:

```{r}
penguins = penguins
```

------------------------------------------------------------------------

## 1. Adding new columns with `mutate()`

We can add new columns to our dataframe using the `mutate()` function. This is especially powerful when combined with piping.

Use piping to create a new column called `bill_length_cm` where the `bill_length_mm` is converted to centimeters (divide by 10).

```{r}
bill_cm_df <- penguins %>%
  mutate(bill_length_cm = bill_length_mm / 10)
```

You can also use mutate to combine the entries in each column. Use piping to create a new column called `total_bill_mm` that is the sum of `bill_length_mm` and `bill_depth_mm`.

```{r}
total_df <- penguins %>% 
  mutate(total_bill_mm = bill_length_mm + bill_depth_mm)
```

**Practice**: Use piping to create a new column called `mass_kg` where the `body_mass_g` is converted to kilograms (divide by 1000).

```{r}
penguins %>%
  mutate(mass_kg = body_mass_g / 1000)
```

------------------------------------------------------------------------

## 2. Grouping and counting with `group_by()` and `tally()`

For categorical data, it can be helpful to count members of a group. We can do this by combining `group_by()` and `tally()`.

Count the number of penguins of each sex:

```{r}
penguins %>%
  group_by(sex) %>%
  tally()
```

Currently we have 11 NA penguins included. We should remove these and create a clean table:

```{r}
clean_penguins <- penguins %>%
  group_by(sex) %>%
  filter(!is.na(sex)) %>%
  tally()

clean_penguins
```

------------------------------------------------------------------------

## 3. Summarizing data with `group_by()` and `summarize()`

We can also use `group_by()` with `summarize()`. The main difference is that the non-grouping and non-output columns are removed.

Summarize the average bill length (in mm) by sex:

```{r}
bill_df <- penguins %>%
  group_by(sex) %>%
  filter(!is.na(sex)) %>%
  summarize(
    mean_bill_length = mean(bill_length_mm, na.rm = TRUE)
  )

bill_df
```

**Practice**: Summarize the average flipper length by island.

```{r}
penguins %>% 
  group_by(island) %>% 
  summarize(avg_flipper_len = mean(flipper_length_mm, na.rm = TRUE))

```

------------------------------------------------------------------------

## 4. Saving data to a file

You can save results to a file using the `write_csv()` function. This can be useful for later applications.

Save `bill_df` as a .csv file in our data directory:

```{r}
write_csv(bill_df, "data/bill_df.csv")
```

------------------------------------------------------------------------

## 5. Using `count()` and `arrange()`

The `count()` function can be very helpful since it combines `group_by()` and `tally()` together.

The `arrange()` function sorts the data: - To sort by ascending numbers: `arrange(n)` - To sort by descending numbers: `arrange(desc(n))`

Count distinct number of penguin species in ascending order:

```{r}
penguin_counts <- penguins %>%
  count(species) %>%
  arrange(n)

penguin_counts
```

Count distinct number of penguin species in descending order:

```{r}
penguin_counts_desc <- penguins %>%
  count(species) %>%
  arrange(desc(n))

penguin_counts_desc
```

**Practice**: Count the number of penguins by island and arrange in descending order.

```{r}
island_count_desc <- penguins %>% 
  count(island) %>% 
  arrange(desc(n))

island_count_desc
```

------------------------------------------------------------------------

## 6. Using the `%in%` operator

Sometimes we only want to include specific values. The `%in%` operator is very helpful! This works similarly to OR statements.

Extract data specifying which species to keep: Adelie and Chinstrap:

```{r}
penguins_reduced <- penguins %>%
  filter(species %in% c("Adelie", "Chinstrap"))
```

This will create the same result as using multiple OR statements:

```{r}
penguins_reduced_same <- penguins %>%
  filter(species == "Adelie" | species == "Chinstrap")
```

**Practice**: Filter penguins to include only those from "Biscoe" and "Dream" islands.

```{r}
penguins %>% 
  filter(island %in% c("Biscoe", "Dream"))

```

------------------------------------------------------------------------

## 7. Applying concepts with the clinical dataframe

Let's try these functions with the `clinical` dataframe!

Load the clinical data:

```{r}
clinical <- read_csv("data/clinical.csv")
```

Count the number of each AJCC pathological stage and remove the NAs:

```{r}
clinical %>%
  group_by(ajcc_pathologic_stage) %>%
  filter(!is.na(ajcc_pathologic_stage)) %>%
  tally()
```

**Practice**: Count the number of patients by gender and remove NAs.

```{r}
clinical %>%
  group_by(gender) %>%
  filter(!is.na(gender)) %>%
  tally()

```

------------------------------------------------------------------------

## 8. Advanced summarizing with clinical data

Summarize the average age at diagnosis (in days) by tissue or organ of origin in a data frame called `age_tissue_df`:

```{r}
age_tissue_df <- clinical %>%
  group_by(tissue_or_organ_of_origin) %>%
  filter(!is.na(tissue_or_organ_of_origin)) %>%
  summarize(
    mean_age = mean(age_at_diagnosis, na.rm = TRUE)
  )

age_tissue_df
```

It can be difficult to tell how old someone is in days. Let's add a new column to `age_tissue_df` to convert to years:

```{r}
age_tissue_years_df <- age_tissue_df %>%
  mutate(mean_age_years = mean_age / 365)

age_tissue_years_df
```

Save the new dataframe as a CSV file:

```{r}
write_csv(age_tissue_years_df, "data/age_tissue_years_df.csv")
```

**Practice**: Summarize the average pack years smoked by gender.

```{r}
clinical %>% 
  group_by(gender) %>% 
  summarise(
    avg_pack_yr = mean(pack_years_smoked, na.rm = TRUE)
  )

```

------------------------------------------------------------------------

## 9. More practice with `count()` and `arrange()`

Count distinct number of tissues or organs of origin in ascending order:

```{r}
tissue_organ_counts <- clinical %>%
  count(tissue_or_organ_of_origin) %>%
  arrange(n)

tissue_organ_counts
```

**Practice**: Count the number of patients by race and arrange in descending order.

```{r}
patient_race_counts <- clinical %>%
  count(race) %>%
  arrange(desc(n))

patient_race_counts

```

------------------------------------------------------------------------

## 10. Using `%in%` with clinical data

Extract data specifying which years of diagnosis to keep: 2010-2013:

```{r}
clinical_reduced <- clinical %>%
  filter(year_of_diagnosis %in% c(2010:2013))
```

This creates the same result as using multiple OR statements:

```{r}
clinical_reduced_same <- clinical %>%
  filter(year_of_diagnosis == 2010 |
         year_of_diagnosis == 2011 |
         year_of_diagnosis == 2012 |
         year_of_diagnosis == 2013)
```

**Practice**: Filter the clinical data to include only patients with "Primary Tumor" or "Metastatic" sample types.

```{r}
clinical %>% 
  filter(sample_type %in% c("Primary Tumor", "Metastatic"))

```

